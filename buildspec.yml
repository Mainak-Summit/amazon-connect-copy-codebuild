version: 0.2

phases:
  pre_build:
    commands:
      - echo "Installing AWS CLI and amazon-connect-copy tool"
      - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      - unzip -q awscliv2.zip
      - sudo ./aws/install -i /usr/local/aws-cli -b /usr/local/bin --update
      - export PATH="/usr/local/bin:$PATH"
      - git clone https://github.com/Mainak-Summit/amazon-connect-copy
      - cp amazon-connect-copy/bin/* /usr/local/bin
      - chmod 755 -R /usr/local/bin/

      - echo "Fetching AWS credentials from Secrets Manager"

      # Fetch source credentials JSON from Secrets Manager
      - CONNECT_SECRET=$(aws secretsmanager get-secret-value --secret-id "$SECRET_NAME" --region "$SECRET_REGION")
      - export SOURCE_AWS_ACCESS_KEY_ID=$(echo $CONNECT_SECRET | jq -r '.SecretString' | jq -r '.SourceAccessKeyId')
      - export SOURCE_AWS_SECRET_ACCESS_KEY=$(echo $CONNECT_SECRET | jq -r '.SecretString' | jq -r '.SourceSecretAccessKey')
      - export SOURCE_AWS_SESSION_TOKEN=$(echo $CONNECT_SECRET | jq -r '.SecretString' | jq -r '.SourceSessionToken')

      # Fetch target credentials JSON from Secrets Manager
      - export TARGET_AWS_ACCESS_KEY_ID=$(echo $CONNECT_SECRET | jq -r '.SecretString' | jq -r '.TargetAccessKeyId')
      - export TARGET_AWS_SECRET_ACCESS_KEY=$(echo $CONNECT_SECRET | jq -r '.SecretString' | jq -r '.TargetSecretAccessKey')
      - export TARGET_AWS_SESSION_TOKEN=$(echo $CONNECT_SECRET | jq -r '.SecretString' | jq -r '.TargetSessionToken')

      # Create AWS CLI profiles from secrets
      - >
        printf "[source]\nregion=$SOURCE_REGION\naws_access_key_id=$SOURCE_AWS_ACCESS_KEY_ID
        aws_secret_access_key=$SOURCE_AWS_SECRET_ACCESS_KEY
        aws_session_token=$SOURCE_AWS_SESSION_TOKEN\n" > ~/.aws/credentials
      - >
        printf "[target]\nregion=$TARGET_REGION\naws_access_key_id=$TARGET_AWS_ACCESS_KEY_ID
        aws_secret_access_key=$TARGET_AWS_SECRET_ACCESS_KEY
        aws_session_token=$TARGET_AWS_SESSION_TOKEN\n" >> ~/.aws/credentials

  build:
    commands:
      - echo "Starting replication process..."

      - |
        echo "Exporting from source instance ($SOURCE_REGION)..."
        export AWS_DEFAULT_REGION="$SOURCE_REGION"
        if [ "$SCOPE" = "ALL" ]; then
          connect_save -p source "$SOURCE_INSTANCE"
        else
          connect_save -p source -c "$SCOPE" "$SOURCE_INSTANCE"
        fi

      - |
        echo "Exporting from target instance ($TARGET_REGION)..."
        export AWS_DEFAULT_REGION="$TARGET_REGION"
        if [ "$SCOPE" = "ALL" ]; then
          connect_save -p target "$TARGET_INSTANCE"
        else
          connect_save -p target -c "$SCOPE" "$TARGET_INSTANCE"
        fi

      - connect_diff "$SOURCE_INSTANCE" "$TARGET_INSTANCE" diff

      - echo "Applying changes to target instance..."
      - export AWS_DEFAULT_REGION="$TARGET_REGION"
      - connect_copy diff

      - date=$(date '+%Y/%m/%d')
      - s3_path="${SOURCE_ENV}_TO_${TARGET_ENV}"
      - aws s3 cp . "s3://${S3_BUCKET}/${date}/${s3_path}/${CODEBUILD_BUILD_NUMBER}" --recursive
